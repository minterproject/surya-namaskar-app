<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SuryaNamaskar">
  <title>Surya Namaskar Counter</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00e0ff">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
  <script>
    // Register service worker with enhanced caching
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful');
            
            // Force cache all resources immediately
            const messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = function(event) {
              if (event.data.success) {
                console.log('✅ All resources cached - app will work offline!');
                // Show user feedback
                if (window.location.hash !== '#offline-ready') {
                  setTimeout(() => {
                    const notice = document.createElement('div');
                    notice.style.cssText = `
                      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                      background: #32be70; color: white; padding: 10px 20px;
                      border-radius: 8px; z-index: 1000; font-size: 14px;
                    `;
                    notice.textContent = '✅ App cached - works offline now!';
                    document.body.appendChild(notice);
                    setTimeout(() => notice.remove(), 3000);
                  }, 1000);
                }
              } else {
                console.error('Failed to cache resources:', event.data.error);
              }
            };
            
            if (registration.active) {
              registration.active.postMessage({type: 'CACHE_URLS'}, [messageChannel.port2]);
            }
            
            // Check if there's a waiting service worker
            if (registration.waiting) {
              console.log('Service Worker is waiting to activate');
            }
            
            // Listen for updates
            registration.addEventListener('updatefound', () => {
              console.log('Service Worker update found');
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('New Service Worker installed, reload to activate');
                }
              });
            });
          })
          .catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
      
      // Handle offline/online events
      window.addEventListener('online', () => {
        console.log('Back online');
      });
      
      window.addEventListener('offline', () => {
        console.log('Gone offline - using cached version');
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <h1>Surya Namaskar</h1>
      <div class="nav-buttons">
        <!-- Session control buttons (shown during active session) -->
        <button id="pauseBtn" type="button" class="hidden" aria-label="Pause Session">
          <svg class="icon-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        </button>
        <button id="resumeBtn" type="button" class="hidden" aria-label="Resume Session">
          <svg class="icon-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="5,3 19,12 5,21"/></svg>
        </button>
        <button id="stopBtn" type="button" class="hidden" aria-label="Stop Session">
          <svg class="icon-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="6" y="6" width="12" height="12"/></svg>
        </button>
        
        <!-- Navigation buttons -->
        <button id="historyBtn" type="button" aria-label="Show History">
          <svg class="icon-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </button>
        <button id="homeBtn" type="button" class="hidden" aria-label="Go Home">
          <svg class="icon-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 12L12 3l9 9"/><path d="M9 21V9h6v12"/></svg>
        </button>
      </div>
    </div>

    <!-- Active Session (Top Priority) -->
    <section class="session-section hidden" id="sessionSection">
      <h2>Active Session</h2>
      <div class="status">
        <span id="cycleStatus"></span>
        <span id="stepStatus"></span>
      </div>
      <div class="timer">
        <span id="timerLabel"></span>
        <span id="timerValue"></span>
      </div>
      <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
      </div>
    </section>

    <!-- Configuration Section -->
    <section class="config-section" id="configSection">
      <form id="configForm" autocomplete="off">
        <label>
          Total SuryaNamaskar:
          <input type="number" id="cyclesInput" min="0.5" max="108" step="0.5" value="5" required>
          <small>You can use half cycles (e.g., 5.5)</small>
        </label>
        <label>
          Pause Between Steps (sec):
          <input type="number" id="stepPauseInput" min="0" max="60" step="0.5" value="5" required>
        </label>
        <label>
          Pause Between SuryaNamaskar (sec):
          <input type="number" id="cyclePauseInput" min="0" max="300" step="0.5" value="30" required>
        </label>
        <button type="submit" id="startBtn">Start Session</button>
      </form>
    </section>

    <!-- History Section -->
    <section class="history-section hidden" id="historySection">
      <h2>History</h2>
      <ul id="historyList"></ul>
    </section>
  </div>
  
  <!-- Session Complete Modal -->
  <div id="sessionComplete" class="modal hidden">
    <div class="modal-content">
      <h2>Session Complete!</h2>
      <p>Great job! You have completed your SuryaNamaskar session.</p>
      <button id="closeSessionComplete">Close</button>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirm" class="modal hidden">
    <div class="modal-content">
      <p>Delete this history entry?</p>
      <button id="confirmDelete">Delete</button>
      <button id="cancelDelete">Cancel</button>
    </div>
  </div>
  <script src="app.js"></script>
</body>
</html>